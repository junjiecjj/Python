# 基于 TDoA 与 Levenberg-Marquardt 算法的无线定位仿真理论研究

## 1 引言

无线定位技术在通信、导航、物联网等领域具有广泛应用，到达时间差（Time Difference of Arrival, TDoA）作为核心定位方法之一，通过测量目标信号到达多个基站（Transmission and Reception Point, TRP）的时间差反推目标位置，兼具定位精度与系统复杂度的平衡优势。本文针对复杂无线环境下的 TDoA 定位问题，整合 LoS（Line of Sight, 视距）与 NLoS（Non-Line of Sight, 非视距）传播场景，构建包含散射体建模、高精度到达时间（Time of Arrival, TOA）估计及稳健位置解算的完整仿真体系，其理论基础与技术实现围绕核心代码的功能模块展开系统阐述。

## 2 核心理论基础

### 2.1 TDoA 定位基本原理

TDoA 定位的核心思想是通过消除信号传输起始时间的未知性，利用目标到不同基站的距离差构建定位方程。设参考基站坐标为$  \boldsymbol{S}_r = [x_r, y_r]^T  $，其余基站坐标为$  \boldsymbol{S}_i = [x_i, y_i]^T  $（$  i=1,2,...,M-1  $，$  M  $为基站总数），目标未知位置为$  \boldsymbol{U} = [x, y]^T  $。

目标到基站的视距距离满足$  d_i = \sqrt{(x - x_i)^2 + (y - y_i)^2} = c \cdot \tau_i  $，其中$  c  $为光速，$  \tau_i  $为信号到达第$  i  $个基站的 TOA。定义到达时间差$  \Delta \tau_i = \tau_i - \tau_r  $，则对应的距离差为$  \Delta d_i = c \cdot \Delta \tau_i = d_i - d_r  $，由此建立非线性定位方程组：

$ 
\sqrt{(x - x_i)^2 + (y - y_i)^2} - \sqrt{(x - x_r)^2 + (y - y_r)^2} = \Delta d_i \quad (i=1,2,...,M-1)
 $

当基站数量$  M \geq 3  $时，通过求解该方程组可唯一确定目标位置$  \boldsymbol{U}  $。

### 2.2 无线传播模型（LoS/NLoS 与散射体建模）

#### 2.2.1 LoS/NLoS 链路特性

无线信道中，信号传播存在 LoS 与 NLoS 两种模式：

* LoS 链路：信号直接从目标传输至基站，无遮挡干扰，传播距离为直线距离$  d_{\text{LoS}}  $，振幅衰减遵循$  1/d  $路径损耗模型；

* NLoS 链路：信号经环境散射体反射后到达基站，采用单次散射模型，传播距离为$  d_{\text{NLoS}} = |\boldsymbol{U} - \boldsymbol{S}_k| + |\boldsymbol{S}_k - \boldsymbol{S}_i|  $（$  \boldsymbol{S}_k  $为第$  k  $个散射体坐标），并引入额外反射衰减系数$  \text{reflAtten}  $修正振幅损耗。

链路 LoS 概率由参数$  \text{losProb}  $控制，通过随机数生成实现 LoS/NLoS 链路的随机模拟，且强制参考基站为 LoS 链路以保证定位基准的稳定性。

#### 2.2.2 散射体建模

环境散射体采用随机分布模型，在指定场地范围$  [0, \text{areaSize}(1)] \times [0, \text{areaSize}(2)]  $内生成$  \text{Nscatter}  $个散射体，坐标通过均匀随机函数生成。对于 NLoS 链路，选择使传播距离最小的散射体作为信号反射点，确保符合实际传播中能量损耗最小的物理规律。

### 2.3 高精度 TOA 估计方法

TOA 估计精度直接决定 TDoA 定位性能，采用 “Zadoff-Chu（ZC）序列探针 + 匹配滤波 + 三点插值” 的组合方案：

* ZC 序列特性：ZC 序列是恒包络零自相关（Constant Amplitude Zero Auto-Correlation, CAZAC）序列，表达式为$  zc(n) = \exp(-j\pi \cdot \text{root} \cdot n(n+1)/\text{Nzc})  $（$  n=0,1,...,\text{Nzc}-1  $），具有良好的自相关性和抗干扰能力，适合作为信号探测序列；

* 匹配滤波：通过计算接收信号与本地 ZC 序列的互相关函数，利用相关峰值位置初步估计信号到达时刻；

* 三点插值：针对离散采样导致的整数时延估计误差，采用三点二次插值优化，通过峰值附近三点的相关值$  y_1,y_2,y_3  $计算分数时延偏移$  \delta = 0.5(y_1 - y_3)/(y_1 - 2y_2 + y_3)  $，实现亚采样级别的高精度 TOA 估计。

### 2.4 Levenberg-Marquardt（LM）稳健优化算法

TDoA 定位方程组为非线性方程，采用 LM 算法求解非线性最小二乘问题，兼顾高斯 - 牛顿法的收敛速度与梯度下降法的稳定性。其核心思想是通过引入阻尼因子$  \lambda  $调节迭代方向：

1. 目标函数：定义加权残差平方和为$  J(\boldsymbol{p}) = \sum_{i=1}^{K-1} w_i \cdot [\sqrt{(x - x_i)^2 + (y - y_i)^2} - \sqrt{(x - x_r)^2 + (y - y_r)^2} - \Delta d_i]^2  $，其中$  w_i  $为基于接收信号峰值幅度的权重，$  K  $为参与定位的基站数；

2. 迭代更新：构造雅可比矩阵$  \boldsymbol{J}  $与海森矩阵近似$  \boldsymbol{H} = \boldsymbol{J}^T \boldsymbol{W} \boldsymbol{J}  $（$  \boldsymbol{W}  $为权重对角矩阵），迭代步长为$  \Delta \boldsymbol{p} = -(\boldsymbol{H} + \lambda \cdot \text{diag}(\boldsymbol{H}))^{-1} \boldsymbol{J}^T \boldsymbol{W} \boldsymbol{r}  $；

3. 阻尼因子自适应调整：若残差减小则减小$  \lambda  $（增强高斯 - 牛顿特性），若残差增大则增大$  \lambda  $（增强梯度下降特性），确保迭代收敛。

此外，通过设置迭代次数上限$  \text{maxIter}  $、收敛阈值$  \text{tol}  $、步长限制$  \text{stepClip}  $等参数，进一步提升算法的稳健性。

## 3 仿真系统设计

### 3.1 系统参数配置

仿真系统的核心参数可根据场景需求灵活调整，关键参数包括：

* 基础物理参数：光速$  c = 299792458 \, \text{m/s}  $、采样率$  f_s  $（决定 TOA 估计分辨率）；

* 场景参数：场地尺寸$  \text{areaSize}  $、基站坐标$  \text{TRP}  $、目标用户数$  N_{\text{UE}}  $、散射体数量$  \text{Nscatter}  $；

* 信道参数：接收信噪比$  \text{SNRdB}  $、LoS 概率$  \text{losProb}  $、NLoS 反射衰减$  \text{reflAtten}  $；

* 算法参数：LM 算法的阻尼因子初始值$  \lambda_0  $、增减系数$  \lambda_{\text{Grow}}/\lambda_{\text{Shrink}}  $、权重下限$  w_{\text{Floor}}  $。

通过固定随机种子$  \text{rng}(2025)  $确保仿真结果的可重复性。

### 3.2 信号生成与接收流程

1. 发射信号构造：ZC 序列前后补零（$  \text{guardZeros}  $）以避免卷积越界，形成发射信号$  \text{tx}  $；

2. 接收信号生成：根据 LoS/NLoS 链路类型，计算信号传播时延$  \tau_m  $与振幅衰减，通过线性插值实现分数时延的信号延迟，叠加符合信噪比要求的复高斯白噪声；

3. 信号预处理：对接收信号进行匹配滤波与三点插值，输出高精度 TOA 估计值$  \text{est\_tau}  $。

### 3.3 定位解算流程

1. 基站筛选：支持两种基站选择模式，即全部基站参与或仅 LoS 基站参与（需满足至少 3 个 LoS 基站 + 参考基站），当 LoS 基站不足时自动切换至全部基站模式；

2. 量测门控：基于场地几何特征计算距离差合理范围，剔除超出边界的异常量测值，避免无效解算；

3. 初始值设置：以参与定位基站的坐标均值作为 LM 算法的初始迭代值，提升收敛速度；

4. 位置解算与验证：通过 LM 算法迭代求解目标位置，判断迭代收敛性与解的有效性，输出最终位置估计值$  \text{UE\_est}  $。

## 4 性能评估方法

### 4.1 统计指标

针对定位结果的有效性与精度，定义核心统计指标：

* 解算成功率：有效定位次数与总用户数的比值（有效定位指解算收敛且位置在合理范围）；

* 误差指标：定位误差（目标真值与估计值的欧氏距离）的均值、中位数、10% 分位数（P10）、90% 分位数（P90）及最大值；

* 算法效率：LM 算法的平均迭代次数与参与定位的平均基站数。

### 4.2 可视化分析

为直观呈现定位性能与系统特性，设计多维度可视化方案：

* 几何分布图：展示基站、散射体、目标真值与估计值的空间分布，及定位误差向量；

* NLoS 路径示意图：单独呈现单个目标的 NLoS 传播路径（目标 - 散射体 - 基站），验证散射体建模合理性；

* 误差 CDF 曲线：反映定位误差的累积分布特性，用于评估不同误差水平的覆盖概率；

* 误差直方图：展示定位误差的概率密度分布，反映误差集中趋势；

* 区域误差热力图：将场地划分为网格，以网格内定位误差的中位数为指标，呈现区域定位精度差异。

## 5 总结

本文基于 TDoA 定位技术，构建了融合复杂无线传播模型、高精度 TOA 估计与稳健优化算法的无线定位仿真系统。核心理论涵盖 TDoA 定位方程、LoS/NLoS 单次散射传播模型、ZC 序列匹配滤波与三点插值的 TOA 估计方法，以及 LM 算法的非线性最小二乘求解方案。通过灵活的参数配置、严谨的解算流程与多维度的性能评估，实现了对不同无线环境下定位性能的全面仿真与分析，为实际 TDoA 定位系统的设计与优化提供了理论支撑与仿真工具。

要不要我帮你整理一份**仿真系统理论与代码模块对应表**，更清晰地呈现每个代码模块的理论依据？

